<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Infrastructure Monitoring Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <style>
    /* Global Dark Theme Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }
    body {
      background: #1e1f22;
      color: #fff;
      overflow-x: hidden;
    }
    h1, h2, h3, h4, h5 {
      margin: 0;
      font-weight: normal;
    }

    /* Dashboard Container */
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
    }

    /* Header / Title */
    .dashboard-header {
      text-align: center;
      margin-bottom: 1rem;
    }
    .dashboard-header h1 {
      font-size: 1.8rem;
    }

    /* Button Bar */
    .button-bar {
      text-align: center;
      margin-bottom: 1rem;
    }
    .button-bar button, .button-bar input[type="file"] {
      display: inline-block;
      margin: 0.5rem;
      padding: 8px 12px;
      background: #6c0344;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .button-bar button:hover, .button-bar input[type="file"]:hover {
      background: #640452;
    }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      flex: 1;
      min-width: 200px;
      background: #2a2b2f;
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .stat-card h2 {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
    }
    .stat-card p {
      font-size: 1.2rem;
      color: #ddd;
    }

    /* Charts + Map Layout */
    .main-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .chart-section, .map-section {
      flex: 1;
      min-width: 350px;
      background: #2a2b2f;
      border-radius: 8px;
      padding: 1rem;
    }
    .chart-section h3, .map-section h3 {
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
      color: #ccc;
    }
    /* Chart Canvas */
    .chart-container {
      width: 100%;
      height: 280px;
      position: relative;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* Leaflet Map */
    #map {
      width: 100%;
      height: 280px;
      border-radius: 5px;
    }

    /* Bottom Table / Additional Info */
    .bottom-row {
      margin-top: 1rem;
      background: #2a2b2f;
      border-radius: 8px;
      padding: 1rem;
    }
    .bottom-row h3 {
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
      color: #ccc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    table th, table td {
      border: 1px solid #3a3b3f;
      padding: 0.6rem;
      text-align: left;
    }
    table th {
      background: #950177;
    }

    .error {
      text-align: center;
      color: #ff8a8a;
      margin-top: 0.75rem;
      min-height: 1.2rem;
    }

    .map-status {
      text-align: center;
      color: #bbb;
      font-size: 0.9rem;
      min-height: 1.2rem;
      margin-top: 0.4rem;
    }

    .map-status.error {
      color: #ff8a8a;
    }

    .table-dropdown {
      border: 1px solid #3a3b3f;
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      background: #1f2024;
    }
    .table-dropdown summary {
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      color: #f1f1f1;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      list-style: none;
    }
    .table-dropdown summary::-webkit-details-marker {
      display: none;
    }
    .summary-arrow {
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid #f1f1f1;
      transition: transform 0.2s ease;
    }
    .table-dropdown[open] .summary-arrow {
      transform: rotate(180deg);
    }

    .month-filter {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      color: #ccc;
      font-size: 0.95rem;
    }
    .month-filter select {
      background: #2a2b2f;
      border: 1px solid #3a3b3f;
      color: #fff;
      padding: 0.35rem 0.75rem;
      border-radius: 6px;
      min-width: 160px;
    }
    .month-filter select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Print Styles */
    @media print {
      .button-bar {
        display: none;
      }
      body {
        background: #efebeb;
      }
    }
  </style>
</head>
<body>

  <div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
      <h1>Infrastructure Monitoring Report</h1>
    </div>

    <!-- Button Bar for CSV Uploads and PDF Download -->
    <div class="button-bar">
      <!-- CSV Upload for Points Data -->
      <input type="file" id="csvFileInput" accept=".csv" title="Upload Points Data CSV">
      <!-- Download PDF Button -->
      <button id="downloadPdfBtn">Download PDF</button>
      <!-- Print Button -->
      <button onclick="window.print()">Print / Save as PDF</button>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-card">
        <h2>Total Points</h2>
        <p id="totalPoints">--</p>
      </div>
      <div class="stat-card">
        <h2>Remediated</h2>
        <p id="remediatedPoints">--</p>
      </div>
      <div class="stat-card">
        <h2>Watching</h2>
        <p id="watchPoints">--</p>
      </div>
      <div class="stat-card">
        <h2>Erosion Susceptibility Risk</h2>
        <p id="erosionValue">High</p>
      </div>
      <div class="stat-card">
        <h2>Points Acknowledged</h2>
        <p id="acknowledgedPoints">--</p>
      </div>
    </div>

    <!-- Main Content: Charts & Map -->
    <div class="main-row">
      <!-- Bar Chart Section -->
      <div class="chart-section">
        <h3>Exposure by NES-PF Erosion Susceptibility Classification</h3>
        <div class="chart-container">
          <canvas id="barChart"></canvas>
        </div>
      </div>
      <!-- Line Chart Section: Historic Rainfall -->
      <div class="chart-section">
        <h3>Regional Rainfall Totals</h3>
        <div class="chart-container">
          <canvas id="lineChart"></canvas>
        </div>
      </div>
      <!-- Map Section -->
      <div class="map-section">
        <h3>Map Overview</h3>
        <div id="map"></div>
        <div id="mapStatus" class="map-status"></div>
      </div>
    </div>

    <!-- Bottom Table: Points Overview -->
    <div class="bottom-row">
      <div class="month-filter">
        <label for="monthFilter">Filter by month:</label>
        <select id="monthFilter">
          <option value="all">All months</option>
        </select>
        <label for="forestFilter">Filter by forest:</label>
        <select id="forestFilter">
          <option value="all">All forests</option>
        </select>
      </div>
      <h3>Points Overview</h3>
      <details class="table-dropdown" id="pointsToggle">
        <summary>
          <span class="summary-arrow"></span>
          <span id="pointsSummaryText">Show all points</span>
        </summary>
        <div>
          <table>
            <thead>
              <tr>
                <th>Point ID</th>
                <th>Status</th>
                <th>Longitude</th>
                <th>Latitude</th>
                <th>Forest</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="pointsTableBody">
              <!-- Populated by JS -->
            </tbody>
          </table>
          <div id="errorMessage" class="error"></div>
        </div>
      </details>
    </div>
  </div>

  <script>
    /***************************************************
     * 1) MAP INIT (Leaflet)
     ***************************************************/
    const DEFAULT_CENTER = [-41.42, 173.85];
    const DEFAULT_ZOOM = 10;
    const map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    const MAP_GEOJSON_URL = 'https://schroderhill.github.io/Client1_pointdata/points_geojson.geojson';
    const mapStatusEl = document.getElementById('mapStatus');

    function setMapStatus(message = '', isError = false) {
      if (!mapStatusEl) return;
      mapStatusEl.textContent = message;
      mapStatusEl.classList.toggle('error', isError);
    }

    async function loadMapData() {
      try {
        setMapStatus('Loading map points...');
        const response = await fetch(MAP_GEOJSON_URL, { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const geojsonData = await response.json();
        const geojsonLayer = L.geoJSON(geojsonData, {
          pointToLayer: function (_feature, latlng) {
            return L.circleMarker(latlng, {
              radius: 5,
              fillColor: '#ff7800',
              color: '#000',
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            });
          }
        }).addTo(map);

        const bounds = geojsonLayer.getBounds();
        if (bounds.isValid()) {
          map.fitBounds(bounds.pad(0.1));
        } else {
          map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);
        }
        setMapStatus('');
      } catch (error) {
        console.error('Failed to load map data', error);
        setMapStatus('Failed to load map points.', true);
      }
    }

    loadMapData();

    /***************************************************
     * 2) CHARTS INIT (Chart.js)
     ***************************************************/
    // Bar Chart: Erosion Risk Distribution (Sample Data)
    const barCtx = document.getElementById('barChart').getContext('2d');
    const barChart = new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: ['Low', 'Medium', 'High', 'Very High'],
        datasets: [{
          label: 'Exposure (%)',
          data: [1, 1, 100, 1], // Using 1 to render a small bar for 0 values
          backgroundColor: ['#3fcf30','#f9ec00','#f58a00','#f70000']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: '#ccc' } },
          y: { 
            ticks: { 
              color: '#ccc',
              callback: function(value) {
                return value + '%'
              }
            }, 
            beginAtZero: true,
            max: 100
          }
        },
        plugins: {
          legend: { labels: { color: '#ccc' } },
          title: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  // Show 0% if value is the placeholder 1
                  const val = context.parsed.y === 1 ? 0 : context.parsed.y;
                  label += val + '%';
                }
                return label;
              }
            }
          }
        }
      }
    });

    // Line Chart: Historic Rainfall (Default Sample Data)
    // Data from Waikawa at DOONS valley graph.
    const lineCtx = document.getElementById('lineChart').getContext('2d');
    const lineChart = new Chart(lineCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Monthly Rainfall (mm)',
          data: [],
          borderColor: '#49abff',
          backgroundColor: 'rgba(73,171,255,0.1)',
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: '#ccc' } },
          y: { 
            ticks: { color: '#ccc' }, 
            beginAtZero: true,
            title: {
              display: true,
              text: 'Rainfall (mm)',
              color: '#ccc'
            }
          }
        },
        plugins: {
          legend: { labels: { color: '#ccc' } },
          title: { display: false }
        }
      }
    });

    /***************************************************
     * 3) GOOGLE SHEET DATA (Points Overview)
     ***************************************************/
    const SHEET_PUBLISH_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1og_gVncTe4fpzDZsLZorEhS4fQtDBbqsa0rFHInH7NN3J9owDTbHKbTB9kO27n1kMD1CL6odRjMZ/pubhtml';
    const CSV_URL = SHEET_PUBLISH_URL.replace('pubhtml', 'pub?output=csv');
    const WATCH_STATUSES = ['watched', 'watching', 'watch'];
    const tableBody = document.getElementById('pointsTableBody');
    const pointsSummaryText = document.getElementById('pointsSummaryText');
    const pointsToggle = document.getElementById('pointsToggle');
    const monthFilterSelect = document.getElementById('monthFilter');
    const forestFilterSelect = document.getElementById('forestFilter');

    let allRows = [];
    let currentMonthFilter = 'all';
    let currentForestFilter = 'all';

    if (monthFilterSelect) {
      monthFilterSelect.addEventListener('change', (event) => {
        currentMonthFilter = event.target.value || 'all';
        applyFilters();
      });
    }

    if (forestFilterSelect) {
      forestFilterSelect.addEventListener('change', (event) => {
        currentForestFilter = event.target.value || 'all';
        applyFilters();
      });
    }

    loadSheetData();

    function loadSheetData() {
      tableBody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
      Papa.parse(CSV_URL, {
        download: true,
        header: false,
        skipEmptyLines: true,
        complete: (results) => {
          const rows = normalizeRows(results.data);
          if (!rows.length) {
            showError('No data found in the published sheet.');
            setAllRows([]);
            return;
          }
          showError('');
          setAllRows(rows);
        },
        error: (err) => {
          showError('Failed to load CSV: ' + err.message);
          setAllRows([]);
        }
      });
    }

    function normalizeRows(rawRows) {
      if (!Array.isArray(rawRows) || rawRows.length === 0) {
        return [];
      }

      const headerIndex = rawRows.findIndex(row => row.some(cell => {
        if (!cell) return false;
        const value = cell.toString().toLowerCase();
        return value.includes('point id') || value.includes('status');
      }));

      if (headerIndex === -1) {
        showError('Could not locate header row in the CSV.');
        return [];
      }

      const headerRow = rawRows[headerIndex].map(cell => (cell || '').toString().trim().toLowerCase());
      const dataRows = rawRows.slice(headerIndex + 1);

      return dataRows
        .map(row => {
          const record = {};
          row.forEach((value, idx) => {
            const key = headerRow[idx] || `col_${idx}`;
            record[key] = (value ?? '').toString().trim();
          });
          return normalizeRecord(record);
        })
        .filter(row => row.id || row.status || row.longitude || row.latitude);
    }

    function normalizeRecord(record) {
      const normalized = {};
      Object.keys(record || {}).forEach(key => {
        if (!key) return;
        const cleanKey = key.replace(/\ufeff/g, '').trim().toLowerCase();
        normalized[cleanKey] = (record[key] ?? '').toString().trim();
      });
      const dateValue = normalized['date'] || normalized['timestamp'] || '';
      const monthParts = getMonthParts(normalized['month'] || '', dateValue);
      return {
        id: normalized['point id'] || normalized['point_id'] || normalized['pointid'] || normalized['id'] || '',
        status: normalized['status'] || '',
        longitude: normalized['longitude'] || normalized['lon'] || normalized['long'] || '',
        latitude: normalized['latitude'] || normalized['lat'] || '',
        forest: normalized['forest'] || '',
        date: dateValue,
        monthLabel: monthParts.label,
        monthSortKey: monthParts.sortKey
      };
    }

    function getMonthParts(monthValue, dateValue) {
      const parsedDate = parseDateSafe(dateValue);
      const cleanMonth = monthValue || '';
      const label = cleanMonth || (parsedDate
        ? parsedDate.toLocaleString('default', { month: 'long', year: 'numeric' })
        : '');
      const sortKey = parsedDate
        ? `${parsedDate.getFullYear()}-${String(parsedDate.getMonth() + 1).padStart(2, '0')}`
        : (label ? label.toLowerCase() : '');
      return { label: label.trim(), sortKey };
    }

    function parseDateSafe(value) {
      if (!value) return null;
      const parsed = new Date(value);
      return Number.isNaN(parsed.getTime()) ? null : parsed;
    }

    function setAllRows(rows) {
      allRows = Array.isArray(rows) ? rows : [];
      populateMonthFilter(allRows);
      populateForestFilter(allRows);
      applyFilters();
    }

    function populateMonthFilter(rows) {
      if (!monthFilterSelect) return;
      const previousValue = currentMonthFilter;
      const monthMap = new Map();
      rows.forEach(row => {
        if (!row.monthLabel) return;
        if (!monthMap.has(row.monthLabel)) {
          monthMap.set(row.monthLabel, row.monthSortKey || row.monthLabel.toLowerCase());
        }
      });

      const sortedMonths = Array.from(monthMap.entries())
        .sort((a, b) => a[1].localeCompare(b[1]))
        .map(entry => entry[0]);

      monthFilterSelect.innerHTML = '<option value="all">All months</option>';
      sortedMonths.forEach(label => {
        const option = document.createElement('option');
        option.value = label;
        option.textContent = label;
        monthFilterSelect.appendChild(option);
      });

      const hasPrevious = previousValue !== 'all' && sortedMonths.includes(previousValue);
      currentMonthFilter = hasPrevious ? previousValue : 'all';
      monthFilterSelect.value = currentMonthFilter;
      monthFilterSelect.disabled = sortedMonths.length === 0;
    }

    function populateForestFilter(rows) {
      if (!forestFilterSelect) return;
      const previousValue = currentForestFilter;
      const forestSet = new Set();
      rows.forEach(row => {
        if (row.forest) {
          forestSet.add(row.forest);
        }
      });

      forestFilterSelect.innerHTML = '<option value="all">All forests</option>';
      Array.from(forestSet)
        .sort((a, b) => a.localeCompare(b))
        .forEach(label => {
          const option = document.createElement('option');
          option.value = label;
          option.textContent = label;
          forestFilterSelect.appendChild(option);
        });

      const hasPrevious = previousValue !== 'all' && forestSet.has(previousValue);
      currentForestFilter = hasPrevious ? previousValue : 'all';
      forestFilterSelect.value = currentForestFilter;
      forestFilterSelect.disabled = forestSet.size === 0;
    }

    function applyFilters() {
      let activeRows = currentMonthFilter === 'all'
        ? allRows
        : allRows.filter(row => row.monthLabel === currentMonthFilter);

      if (currentForestFilter !== 'all') {
        activeRows = activeRows.filter(row => row.forest === currentForestFilter);
      }
      renderPointsTable(activeRows);
      updateSheetStats(activeRows);
      updatePointsSummary(activeRows.length);
    }

    function updateSheetStats(rows) {
      const total = rows.length;
      const remediated = rows.filter(row => (row.status || '').toLowerCase() === 'remediated').length;
      const watching = rows.filter(row => WATCH_STATUSES.includes((row.status || '').toLowerCase())).length;
      const acknowledged = rows.filter(row => (row.status || '').toLowerCase() === 'archived').length;

      document.getElementById('totalPoints').textContent = total;
      document.getElementById('remediatedPoints').textContent = remediated;
      document.getElementById('watchPoints').textContent = watching;
      document.getElementById('acknowledgedPoints').textContent = acknowledged;
    }

    function renderPointsTable(rows) {
      tableBody.innerHTML = '';
      if (!rows.length) {
        tableBody.innerHTML = '<tr><td colspan="6">No data found</td></tr>';
        return;
      }

      rows.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.id || 'N/A'}</td>
          <td>${row.status || 'N/A'}</td>
          <td>${row.longitude || 'N/A'}</td>
          <td>${row.latitude || 'N/A'}</td>
          <td>${row.forest || 'N/A'}</td>
          <td>${row.date || 'N/A'}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
    }

    function updatePointsSummary(count) {
      if (!pointsSummaryText) return;
      const monthLabel = currentMonthFilter !== 'all' ? currentMonthFilter : 'all months';
      const forestLabel = currentForestFilter !== 'all' ? currentForestFilter : 'all forests';
      const scopeLabel = `${monthLabel} / ${forestLabel}`;
      const label = count > 0
        ? `Show ${scopeLabel} (${count}) points`
        : `Show ${scopeLabel} points`;
      pointsSummaryText.textContent = label;
      if (pointsToggle && count === 0) {
        pointsToggle.open = false;
      }
    }

    /***************************************************
     * 4) CSV UPLOAD FOR POINTS DATA
     ***************************************************/
    document.getElementById('csvFileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const normalizedRows = (results.data || [])
            .map(row => normalizeRecord(row))
            .filter(row => row.id || row.status || row.longitude || row.latitude);

          if (!normalizedRows.length) {
            showError('Uploaded CSV did not contain recognizable data.');
            return;
          }

          showError('');
          setAllRows(normalizedRows);
        }
      });
    });

    /***************************************************
     * 5) RAINFALL API FETCH
     ***************************************************/
    async function loadMonthlyRainfall(lat, lng) {
      const endDate = new Date();
      const startDate = new Date();
      startDate.setFullYear(startDate.getFullYear() - 1);

      const formatDate = (date) => date.toISOString().split('T')[0];
      const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lng}&start_date=${formatDate(startDate)}&end_date=${formatDate(endDate)}&daily=precipitation_sum&timezone=Pacific/Auckland`;

      try {
        const data = await fetch(url).then(r => r.json());
        
        const monthlyTotals = {};
        data.daily.time.forEach((dateStr, index) => {
          const date = new Date(dateStr);
          const month = date.toLocaleString('default', { month: 'short', year: '2-digit' });
          if (!monthlyTotals[month]) {
            monthlyTotals[month] = 0;
          }
          monthlyTotals[month] += data.daily.precipitation_sum[index];
        });

        const labels = Object.keys(monthlyTotals);
        const precipitation = Object.values(monthlyTotals).map(val => val.toFixed(2));

        // Ensure chronological order
        const sortedMonths = labels
          .map(label => {
            const [monthStr, yearStr] = label.split(' ');
            return { label, date: new Date(`${monthStr} 1, 20${yearStr}`) };
          })
          .sort((a, b) => a.date - b.date);

        const sortedLabels = sortedMonths.map(item => item.label);
        const sortedPrecipitation = sortedLabels.map(label => precipitation[labels.indexOf(label)]);

        lineChart.data.labels = sortedLabels;
        lineChart.data.datasets[0].data = sortedPrecipitation;
        lineChart.update();

      } catch (error) {
        console.error("Error fetching monthly rainfall:", error);
      }
    }

    // Initial load of rainfall data
    loadMonthlyRainfall(-41.42, 173.85);


    /***************************************************
     * 7) DOWNLOAD PDF FEATURE
     ***************************************************/
    document.getElementById('downloadPdfBtn').addEventListener('click', function() {
      // Use html2pdf to generate PDF of the entire dashboard container
      html2pdf().from(document.querySelector('.dashboard-container')).set({
        margin: 10,
        filename: 'infrastructure_report.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      }).save();
    });
  </script>
</body>
</html>